# ORPC Cloudflare Workers Template

A batteries-included starter for building type-safe REST/RPC APIs on Cloudflare Workers powered by [oRPC](https://github.com/orpc) and D1.

It bundles:

- âš¡ï¸ Cloudflare Workers with Node.js compat
- ğŸŒ€ [oRPC](https://github.com/orpc) server with automatic OpenAPI generation
- ğŸ“„ Interactive API reference served by Scalar UI (`/docs`) and raw spec at `/spec.json`
- ğŸ—„  [Drizzle ORM](https://github.com/drizzle-team/drizzle-orm) + Cloudflare D1
- ğŸ—  Schema-driven validation & typing via [Valibot](https://valibot.dev)
- ğŸ§ª First-class testing using Vitest & `@cloudflare/vitest-pool-workers`
- ğŸ§¹ Consistent formatting / linting with Biome
- ğŸ›   Zero-config local dev with Wrangler

Demo feature: a classic `/todos` CRUD API.

## Requirements

â€¢ Node.js â‰¥ 20 (Cloudflare Workers runtime parity)  
â€¢ pnpm â‰¥ 8 (other package managers will work but commands below assume pnpm)  
â€¢ A Cloudflare account if you want to deploy remotely (optional for local dev)

## Getting started

```bash
# 1. Install dependencies
pnpm install

# 2. Prepare local environment & database
pnpm setup-local         # copies .dev.vars and applies all D1 migrations

# 3. Launch the worker locally
pnpm dev                     # alias for `wrangler dev`
```

Open http://localhost:8787/docs to explore the API and try requests from the browser.  
The raw OpenAPI JSON is available at http://localhost:8787/spec.json.

### Typical commands

| Command | Purpose |
|---------|---------|
| `pnpm dev` | Start local dev server with live-reload |
| `pnpm deploy` | Deploy to your Cloudflare account |
| `pnpm test` | Run Vitest unit/integration suite |
| `pnpm check` | Type-check & lint source code |
| `pnpm db:push` | Sync Drizzle schema to the D1 database defined in wrangler.jsonc |
| `pnpm db:migrate:local` | Apply generated migrations to the local D1 instance |
| `pnpm db:migrate:remote` | Apply migrations to the remote (production) D1 database |
| `pnpm db:generate` | Generate a new migration after modifying schema |

## Project structure

```
src/
 â”œâ”€ db/                 # drizzle schema & client
 â”œâ”€ features/           # domain modules (todos, etc.)
 â”‚   â”œâ”€ common/         # shared helpers & validators
 â”‚   â””â”€ todos/          # example feature router
 â”œâ”€ orpc/               # oRPC initialisation & root router
 â””â”€ index.ts            # Worker entry point
drizzle/                # SQL migrations generated by Drizzle
test/                   # Vitest test setup & specs
```

### Routing

oRPC discovers procedures defined in any `*.router.ts` file.  
Each procedure declares:

- HTTP path & method  
- Input/output validators  
- Description, tags & custom errors  

The OpenAPI generator uses this metadata to build the schema automatically.

### Persistence

The template uses Cloudflare D1 (SQLite) and Drizzle ORM.

1. Define tables in `src/db/schema.ts`.
2. Run `pnpm db:generate` to create a new migration.
3. Apply the migration locally with `pnpm db:migrate:local`  
   (or remotely with `pnpm db:migrate:staging`).

`src/db/client.ts` exports a typed `db` instance injected into every handler through the oRPC context.

## Environment variables

All runtime variables for local development live in `.dev.vars` (loaded by Wrangler).  
An example file is provided.

Add your own variables and bind them in `wrangler.jsonc` as needed.

## Testing

Vitest is configured to spin up an isolated Workers runtime (`cloudflare:test`).  
Run the suite with:

```bash
pnpm test
```

Database migrations are applied automatically in the test harness (`test/apply-migrations.ts`).

## Deployment

Make sure you are authenticated with Wrangler:

```bash
pnpm dlx wrangler login
```

Then deploy:

```bash
pnpm deploy
```

The same worker code runs locally and in production.

## FAQ

â€¢ **Can I add authentication?**  
Yesâ€”define a custom context middleware in `src/orpc/init.ts` and add a `bearerAuth` security scheme in `src/docs.ts`.

â€¢ **Can I use KV, R2, queues, etc.?**  
Absolutely. Add new bindings inside `wrangler.jsonc` and surface them via the oRPC context.

â€¢ **Why pnpm?**  
It is faster and fully supported by Wrangler. Feel free to use npm/yarn if you prefer, but adjust the commands accordingly.
